name: Android Instrumentation Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  instrumented-tests:
    name: Run Instrumentation Tests
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Create AVD
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 29
        arch: x86_64
        profile: Nexus 6
        script: |
          # Grant execute permission for gradlew
          chmod +x gradlew

          # Create google-services.json placeholder
          mkdir -p app
          cat > app/google-services.json << 'EOF'
          {
            "project_info": {
              "project_number": "000000000000",
              "project_id": "test-project",
              "storage_bucket": "test-project.firebasestorage.app"
            },
            "client": [
              {
                "client_info": {
                  "mobilesdk_app_id": "1:000000000000:android:0000000000000000000000",
                  "android_client_info": {
                    "package_name": "com.example.lindonndelivery2"
                  }
                },
                "oauth_client": [],
                "api_key": [
                  {
                    "current_key": "test-api-key"
                  }
                ],
                "services": {
                  "appinvite_service": {
                    "other_platform_oauth_client": []
                  }
                }
              }
            ],
            "configuration_version": "1"
          }
          EOF

          # Run instrumentation tests
          ./gradlew connectedAndroidTest --stacktrace

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: instrumentation-test-results
        path: app/build/outputs/androidTest-results/
        retention-days: 7

